# 麻将AI文档

## 赛制说明
本次大作业国标麻将采用瑞士轮加复式赛赛制。

每匹配到的4位选手将进行4副牌墙的对比，每副牌墙将进行4盘比赛，故一共进行16盘比赛。具体来说，4副牌墙的圈风依次指定为东南西北，每副牌墙进行4盘比赛意味着4位选手的座次安排相对顺序不变，但是每个人会轮流做东（见右下角）。积分规则按“一副一比”，也即每副牌墙进行24盘将得到1个累加分，根据累加分进行排名，从高到低依次得到4/3/2/1的排名分。故每次匹配，选手将得到4个排名分。最后，选手的排名分进行累加，并得到最终的比赛名次。

复式国标麻将使用136张麻将牌，不包含8张花牌。

牌墙为随机生成，平均分成4份，每份为34张，作为指定座次（风位）的牌墙。初始手牌按座次牌墙指定。bot被分配到哪个座次，就拥有那个座次的牌墙，不能从其他牌墙中摸牌。

## 神经网络设计
有用的state信息：

1. 手牌信息。手牌不超过13张，可以用4个channel表示（每个channel为`bool[34]`）
2. 明牌信息。每个玩家的明牌不超过16张（可能有杠），可以用4个channel表示（顺序不重要）；一共需要4\*4个channel，顺序是本家、下家、对家、上家
3. 门风&圈风。均可以用4个channel表示，分别编码东南西北。对应的一个channel全1，其余全0. 一共需要8个channel
4. 场上牌信息。每个玩家场上都只有不超过21张牌，可以用21\*4个channel表示（21编码了打牌顺序，越晚打排在越后），一共有4\*21\*4个channel，顺序是本家、下家、对家、上家。为了普适性，可以使用4\*30\*4个channel
5. 当前操作信息。比如吃/碰/杠/胡，需要当前打牌的风位，当前打出的牌（2*4个channel）；打出牌需要当前摸到牌的信息（4个channel），一共12个channel

这些信息一共需要$(1+4+2+4\times 30+3)\times 4=130\times 4=520$个channel。

除了state信息之外，还可以计算一些look-ahead features（feature engineering）。在麻将中，这主要是和上听数有关的feature。比如，打出某张牌之后，可能在两上听内胡到48番。

结合`shanten.cpp`库的结构，设计这个结构为：5个channel标记打某个牌是否可以减少各种胡牌形式的上听数，5个channel标记打出某个牌是否可以使对应形式听牌（8番以上），10个channel标记打出每种牌可以听牌并胡到8番以上的概率（从.0+~.9+编码，1的个数表示概率），10个channel标记平均番数（0~100），50个channel标记各种胡型的上听数（超过10按10算）

从以上设计可知，我们一共需要520+80=600个channel，网络的输入维度就是600\*4。网络的主体采用ResNet设计：

![Discard Model](model.png)
（图盗）

其中，conv表示Convolutional Neural Network，只卷积，不池化、不BN（Batch Normalization）。输出结果只需要1个channel（Discard就输出可能打出的牌（在其中随机选牌打出），吃碰杠等就看1多还是0多）

## 训练过程

先使用人类玩家数据进行监督学习。

待续